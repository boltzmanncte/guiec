<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:local="clr-namespace:vfv"
             xmlns:models="clr-namespace:vfv.Models"
             xmlns:vm="clr-namespace:vfv.ViewModels"
             xmlns:converters="clr-namespace:vfv.Converters"
             x:Class="vfv.MainPage"
             x:DataType="vm:MainViewModel"
             BackgroundColor="White">

    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:InvertedBoolConverter x:Key="InvertedBoolConverter" />
            <converters:IsNullConverter x:Key="IsNullConverter" />
            <converters:IsNotNullConverter x:Key="IsNotNullConverter" />
            <converters:DeclarationModeTextConverter x:Key="DeclarationModeTextConverter" />
            <converters:DeclarationModeColorConverter x:Key="DeclarationModeColorConverter" />
            <converters:DeclarationModeTextColorConverter x:Key="DeclarationModeTextColorConverter" />
            <converters:DeclarationModeStatusConverter x:Key="DeclarationModeStatusConverter" />
            <converters:FileActiveBackgroundConverter x:Key="FileActiveBackgroundConverter" />
            <converters:ExtensionUpperCaseConverter x:Key="ExtensionUpperCaseConverter" />
            <converters:ProgressPercentConverter x:Key="ProgressPercentConverter" />
            <converters:ProgressTextConverter x:Key="ProgressTextConverter" />
            <converters:DeleteButtonTextConverter x:Key="DeleteButtonTextConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid Padding="20" RowSpacing="20" BackgroundColor="#FAFAFA">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="140" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!-- Top Toolbar -->
        <Grid Grid.Row="0" ColumnSpacing="8">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <!-- Left side buttons -->
                <HorizontalStackLayout Grid.Column="0" Spacing="12">
                    <Button Text="Open File"
                            BackgroundColor="White"
                            TextColor="#1F1F1F"
                            BorderColor="#E0E0E0"
                            BorderWidth="1"
                            CornerRadius="6"
                            Padding="12,8"
                            StyleClass="outline"
                            ImageSource="folder_open.png"
                            Command="{Binding OpenFileCommand}"
                            Pressed="OnButtonPressed"
                            Released="OnButtonReleased">
                        <Button.Shadow>
                            <Shadow Brush="#E0E0E0" Offset="0,1" Radius="2" Opacity="0.1" />
                        </Button.Shadow>
                    </Button>

                    <Border BackgroundColor="#10B981"
                            WidthRequest="42"
                            HeightRequest="42"
                            StrokeThickness="0"
                            Padding="9"
                            x:Name="PlayButton"
                            IsEnabled="{Binding IsExecuting, Converter={StaticResource InvertedBoolConverter}}">
                        <Border.Shadow>
                            <Shadow Brush="#10B981" Offset="0,2" Radius="4" Opacity="0.3" />
                        </Border.Shadow>
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="8" />
                        </Border.StrokeShape>
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding StartExecutionCommand}"
                                                Tapped="OnIconButtonTapped" />
                        </Border.GestureRecognizers>
                        <Image Source="play.png"
                               Aspect="AspectFit"
                               VerticalOptions="Center"
                               HorizontalOptions="Center" />
                    </Border>

                    <Border BackgroundColor="#EF4444"
                            WidthRequest="42"
                            HeightRequest="42"
                            StrokeThickness="0"
                            Padding="9"
                            x:Name="StopButton"
                            IsEnabled="{Binding IsExecuting}">
                        <Border.Shadow>
                            <Shadow Brush="#EF4444" Offset="0,2" Radius="4" Opacity="0.3" />
                        </Border.Shadow>
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="8" />
                        </Border.StrokeShape>
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding StopExecutionCommand}"
                                                Tapped="OnIconButtonTapped" />
                        </Border.GestureRecognizers>
                        <Image Source="square.png"
                               Aspect="AspectFit"
                               VerticalOptions="Center"
                               HorizontalOptions="Center" />
                    </Border>

                    <Button Text="{Binding IsDeclarationMode, Converter={StaticResource DeclarationModeTextConverter}}"
                            BackgroundColor="{Binding IsDeclarationMode, Converter={StaticResource DeclarationModeColorConverter}}"
                            TextColor="{Binding IsDeclarationMode, Converter={StaticResource DeclarationModeTextColorConverter}}"
                            BorderWidth="1"
                            CornerRadius="4"
                            Command="{Binding ToggleDeclarationModeCommand}" />

                    <Label Text="{Binding IsDeclarationMode, Converter={StaticResource DeclarationModeStatusConverter}}"
                           VerticalOptions="Center"
                           TextColor="#666"
                           StyleClass="muted-text" />
                </HorizontalStackLayout>

                <!-- Right side buttons -->
                <HorizontalStackLayout Grid.Column="1" Spacing="12">
                    <Button Text="Tools"
                            BackgroundColor="White"
                            TextColor="#1F1F1F"
                            BorderColor="#E0E0E0"
                            BorderWidth="1"
                            CornerRadius="6"
                            Padding="12,8"
                            StyleClass="outline"
                            ImageSource="wrench.png"
                            Clicked="OnToolsClicked"
                            Pressed="OnButtonPressed"
                            Released="OnButtonReleased">
                        <Button.Shadow>
                            <Shadow Brush="#E0E0E0" Offset="0,1" Radius="2" Opacity="0.1" />
                        </Button.Shadow>
                    </Button>

                    <Button Text="Settings"
                            BackgroundColor="White"
                            TextColor="#1F1F1F"
                            BorderColor="#E0E0E0"
                            BorderWidth="1"
                            CornerRadius="6"
                            Padding="12,8"
                            StyleClass="outline"
                            ImageSource="settings.png"
                            Command="{Binding OpenSettingsCommand}"
                            Pressed="OnButtonPressed"
                            Released="OnButtonReleased">
                        <Button.Shadow>
                            <Shadow Brush="#E0E0E0" Offset="0,1" Radius="2" Opacity="0.1" />
                        </Button.Shadow>
                    </Button>

                    <Button Text="Help"
                            BackgroundColor="White"
                            TextColor="#1F1F1F"
                            BorderColor="#E0E0E0"
                            BorderWidth="1"
                            CornerRadius="6"
                            Padding="12,8"
                            StyleClass="outline"
                            ImageSource="help_circle.png"
                            Clicked="OnHelpClicked"
                            Pressed="OnButtonPressed"
                            Released="OnButtonReleased">
                        <Button.Shadow>
                            <Shadow Brush="#E0E0E0" Offset="0,1" Radius="2" Opacity="0.1" />
                        </Button.Shadow>
                    </Button>
                </HorizontalStackLayout>
        </Grid>

        <!-- Main Content Area -->
        <Grid Grid.Row="1" ColumnSpacing="20">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="*" />
            </Grid.ColumnDefinitions>

            <!-- File List -->
            <Frame Grid.Column="0" BackgroundColor="White" BorderColor="#E5E7EB" Padding="0" HasShadow="True" CornerRadius="8" StyleClass="card">
                <Frame.Shadow>
                    <Shadow Brush="#E0E0E0" Offset="0,2" Radius="8" Opacity="0.3" />
                </Frame.Shadow>
                <Grid RowSpacing="0">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="*" />
                        <RowDefinition Height="Auto" />
                    </Grid.RowDefinitions>

                    <!-- Files ScrollView -->
                    <ScrollView Grid.Row="0">
                        <VerticalStackLayout Padding="16" Spacing="2" BindableLayout.ItemsSource="{Binding Files}">
                            <BindableLayout.ItemTemplate>
                                <DataTemplate x:DataType="models:FileItem">
                                    <Frame Padding="6"
                                           BackgroundColor="{Binding IsActive, Converter={StaticResource FileActiveBackgroundConverter}}"
                                           BorderColor="Transparent"
                                           CornerRadius="6"
                                           HasShadow="False">
                                        <Frame.GestureRecognizers>
                                            <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type vm:MainViewModel}}, Path=SelectFileCommand}"
                                                                CommandParameter="{Binding .}" />
                                        </Frame.GestureRecognizers>

                                        <Grid ColumnSpacing="12">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto" />
                                                <ColumnDefinition Width="Auto" />
                                                <ColumnDefinition Width="*" />
                                                <ColumnDefinition Width="Auto" />
                                            </Grid.ColumnDefinitions>

                                            <CheckBox Grid.Column="0"
                                                    IsChecked="{Binding IsSelected, Mode=TwoWay}"
                                                    Color="#003399"
                                                    StyleClass="primary" />

                                            <Image Grid.Column="1"
                                                   Source="file_text.png"
                                                   WidthRequest="20"
                                                   HeightRequest="20"
                                                   VerticalOptions="Center" />

                                            <Label Grid.Column="2"
                                                   Text="{Binding Name}"
                                                   VerticalOptions="Center"
                                                   FontSize="14"
                                                   StyleClass="body-text" />

                                            <Label Grid.Column="3"
                                                   Text="{Binding Size}"
                                                   VerticalOptions="Center"
                                                   TextColor="#999"
                                                   StyleClass="small-text, muted-text"
                                                   FontSize="12" />
                                        </Grid>
                                    </Frame>
                                </DataTemplate>
                            </BindableLayout.ItemTemplate>
                        </VerticalStackLayout>
                    </ScrollView>

                    <!-- File List Footer -->
                    <Frame Grid.Row="1"
                           BackgroundColor="#F9FAFB"
                           BorderColor="Transparent"
                           Padding="12"
                           HasShadow="False"
                           CornerRadius="0">
                        <Grid ColumnSpacing="8">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>

                            <HorizontalStackLayout Grid.Column="0" Spacing="8">
                                <Button Text="Move Up"
                                        BackgroundColor="White"
                                        TextColor="#333"
                                        BorderColor="#D9D9D9"
                                        BorderWidth="1"
                                        CornerRadius="4"
                                        Padding="8,4"
                                        StyleClass="outline"
                                        ImageSource="chevron_up.png"
                                        ContentLayout="Left,4"
                                        Command="{Binding MoveFileUpCommand}"
                                        Pressed="OnButtonPressed"
                                        Released="OnButtonReleased" />


                                <Button Text="Move Down"
                                        BackgroundColor="White"
                                        TextColor="#333"
                                        BorderColor="#D9D9D9"
                                        BorderWidth="1"
                                        CornerRadius="4"
                                        Padding="8,4"
                                        StyleClass="outline"
                                        ImageSource="chevron_down.png"
                                        ContentLayout="Left,4"
                                        Command="{Binding MoveFileDownCommand}"
                                        Pressed="OnButtonPressed"
                                        Released="OnButtonReleased" />
                            </HorizontalStackLayout>

                            <Border Grid.Column="1"
                                    BackgroundColor="#EF4444"
                                    WidthRequest="42"
                                    HeightRequest="42"
                                    StrokeThickness="0"
                                    Padding="9"
                                    x:Name="DeleteButton">
                                <Border.Shadow>
                                    <Shadow Brush="#EF4444" Offset="0,2" Radius="4" Opacity="0.3" />
                                </Border.Shadow>
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="8" />
                                </Border.StrokeShape>
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding DeleteSelectedFilesCommand}"
                                                        Tapped="OnIconButtonTapped" />
                                </Border.GestureRecognizers>
                                <Image Source="trash_2.png"
                                       Aspect="AspectFit"
                                       VerticalOptions="Center"
                                       HorizontalOptions="Center" />
                            </Border>
                        </Grid>
                    </Frame>
                </Grid>
            </Frame>

            <!-- File Details -->
            <Frame Grid.Column="1" BackgroundColor="White" BorderColor="#E5E7EB" Padding="24" HasShadow="True" CornerRadius="8" StyleClass="card">
                <Frame.Shadow>
                    <Shadow Brush="#E0E0E0" Offset="0,2" Radius="8" Opacity="0.3" />
                </Frame.Shadow>
                <Grid RowSpacing="24" IsVisible="{Binding ActiveFile, Converter={StaticResource IsNotNullConverter}}">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>

                    <!-- File Header -->
                    <VerticalStackLayout Grid.Row="0" Spacing="4">
                        <Label Text="{Binding ActiveFile.Name}"
                               FontSize="20"
                               FontAttributes="Bold"
                               StyleClass="heading-2" />
                        <Label Text="{Binding ActiveFile.Extension, Converter={StaticResource ExtensionUpperCaseConverter}}"
                               TextColor="#999"
                               FontSize="12"
                               StyleClass="small-text, muted-text" />
                    </VerticalStackLayout>

                    <!-- File Properties -->
                    <VerticalStackLayout Grid.Row="1" Spacing="16">
                        <Grid ColumnSpacing="12">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="96" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>
                            <Label Grid.Column="0" Text="Size" TextColor="#999" StyleClass="muted-text" />
                            <Label Grid.Column="1" Text="{Binding ActiveFile.Size}" StyleClass="body-text" />
                        </Grid>

                        <Grid ColumnSpacing="12">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="96" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>
                            <Label Grid.Column="0" Text="Modified" TextColor="#999" StyleClass="muted-text" />
                            <Label Grid.Column="1" Text="{Binding ActiveFile.Modified}" StyleClass="body-text" />
                        </Grid>

                        <Grid ColumnSpacing="12">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="96" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>
                            <Label Grid.Column="0" Text="Created" TextColor="#999" StyleClass="muted-text" />
                            <Label Grid.Column="1" Text="Oct 8, 2025" StyleClass="body-text" />
                        </Grid>

                        <Grid ColumnSpacing="12">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="96" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>
                            <Label Grid.Column="0" Text="Location" TextColor="#999" StyleClass="muted-text" />
                            <Label Grid.Column="1" Text="{Binding ActiveFile.Name, StringFormat='/{0}'}" StyleClass="body-text" />
                        </Grid>
                    </VerticalStackLayout>
                </Grid>

                <!-- Empty State -->
                <Label Text="Select a file to view details"
                       TextColor="#999"
                       HorizontalOptions="Center"
                       VerticalOptions="Center"
                       StyleClass="muted-text"
                       IsVisible="{Binding ActiveFile, Converter={StaticResource IsNullConverter}}" />
            </Frame>
        </Grid>

        <!-- Error Panel -->
        <Frame Grid.Row="2" BackgroundColor="White" BorderColor="#E5E7EB" Padding="16" HasShadow="True" CornerRadius="8" StyleClass="card">
            <Frame.Shadow>
                <Shadow Brush="#E0E0E0" Offset="0,2" Radius="8" Opacity="0.3" />
            </Frame.Shadow>
            <ScrollView>
                <VerticalStackLayout Spacing="8" BindableLayout.ItemsSource="{Binding Errors}">
                    <BindableLayout.EmptyView>
                        <Label Text="No errors"
                               TextColor="#999"
                               HorizontalOptions="Center"
                               VerticalOptions="Center"
                               StyleClass="muted-text" />
                    </BindableLayout.EmptyView>

                    <BindableLayout.ItemTemplate>
                        <DataTemplate x:DataType="x:String">
                            <Frame BackgroundColor="#FEF2F2"
                                   BorderColor="#FCA5A5"
                                   Padding="14"
                                   HasShadow="False"
                                   CornerRadius="6"
                                   StyleClass="alert-error">
                                <Grid ColumnSpacing="8">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto" />
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="Auto" />
                                    </Grid.ColumnDefinitions>

                                    <Image Grid.Column="0"
                                           Source="alert_circle.png"
                                           WidthRequest="16"
                                           HeightRequest="16"
                                           VerticalOptions="Start" />

                                    <Label Grid.Column="1"
                                           Text="{Binding .}"
                                           TextColor="#CC0000"
                                           FontSize="12"
                                           LineBreakMode="WordWrap"
                                           StyleClass="text-destructive, small-text" />

                                    <Button Grid.Column="2"
                                            BackgroundColor="Transparent"
                                            WidthRequest="32"
                                            HeightRequest="32"
                                            Padding="0"
                                            ImageSource="x.png"
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type vm:MainViewModel}}, Path=ClearErrorCommand}"
                                            CommandParameter="{Binding .}" />
                                </Grid>
                            </Frame>
                        </DataTemplate>
                    </BindableLayout.ItemTemplate>
                </VerticalStackLayout>
            </ScrollView>
        </Frame>

        <!-- Footer with Progress -->
        <Frame Grid.Row="3" BackgroundColor="White" BorderColor="#E5E7EB" Padding="16" HasShadow="True" CornerRadius="8" StyleClass="card-muted">
            <Frame.Shadow>
                <Shadow Brush="#E0E0E0" Offset="0,2" Radius="8" Opacity="0.3" />
            </Frame.Shadow>
            <Grid ColumnSpacing="16">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="200" />
                </Grid.ColumnDefinitions>

                <Label Grid.Column="0"
                       Text="{Binding IsExecuting, Converter={StaticResource ProgressTextConverter}, ConverterParameter={Binding Progress}}"
                       VerticalOptions="Center"
                       TextColor="#666"
                       FontSize="12"
                       StyleClass="small-text, muted-text" />

                <ProgressBar Grid.Column="1"
                             Progress="{Binding Progress, Converter={StaticResource ProgressPercentConverter}}"
                             ProgressColor="#003399"
                             VerticalOptions="Center"
                             StyleClass="accent" />
            </Grid>
        </Frame>
    </Grid>
</ContentPage>
